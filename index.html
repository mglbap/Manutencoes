<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Gestão de Manutenções</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #daf0f5; background-image: url("avac.jpg");}
    h2 { margin-top: 0; }
    .tabs { display: flex; margin-bottom: 15px; flex-wrap: wrap; }
    .tab { flex: 1; padding: 10px; text-align: center; background: #ddd; cursor: pointer; border-radius: 15px 15px 0 10px; }
    .tab.active { background: grey; font-weight: bold; border-bottom: 2px solid #fff; }
    .content { display: none; background: #fff; padding: 15px; border-radius: 0 5px 5px 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    .content.active { display: block; }
    form label { display: block; margin: 8px 0 4px; }
    form input, form select, form textarea { width: 100%; padding: 6px; }
    button { margin: 8px 5px 0 0; padding: 6px 12px; cursor: pointer; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    td { border: 1px solid #aaa; padding: 6px; text-align: left; }
    tr.selected { background: #ffe4b5; }
    th {
      border: 1px solid #aaa;
      padding: 6px;
      text-align: center;
      background-color: grey;
    }
    .total { margin-top: 8px; font-weight: bold; text-align: right;}
  </style>
</head>
<body>
  <h1>Gestão de Manutenções</h1>

  <!-- Separadores -->
  <div class="tabs">
    <div class="tab active" data-tab="novo">Novo Registo</div>
    <div class="tab" data-tab="stock">Stock Material</div>
    <div class="tab" data-tab="filtros">Filtros</div>
    <div class="tab" data-tab="notas">Notas</div>
    <div class="tab" data-tab="excel">Importar / Exportar Excel</div>
  </div>

  <!-- Novo Registo -->
  <div class="content active" id="novo">
    <h2>Novo Registo</h2>
    <form id="formNovo">
      <input type="hidden" id="indiceEditarNovo">
      <label>Empresa: <input type="text" id="empresa" required></label>
      <label>Edifício: <input type="text" id="edificio" required></label>
      <label>Tipo: <input type="text" id="tipo" required></label>
      <label>Data: <input type="date" id="dataNovo" required></label>
      <label>Observações: <input type="text" id="obs"></label>
      <button type="submit">Guardar</button>
      <button type="button" onclick="resetForm('formNovo')">Cancelar</button>
    </form>
    <table id="tabelaNovo"><thead><tr><th>Empresa</th><th>Edifício</th><th>Tipo</th><th>Data</th><th>Obs</th></tr></thead><tbody></tbody></table>
    <div id="totalNovo" class="total"></div>
  </div>

  <!-- Stock -->
  <div class="content" id="stock">
    <h2>Stock Material</h2>
    <form id="formStock">
      <input type="hidden" id="indiceEditarStock">
      <label>Data: <input type="date" id="dataStock" required></label>
      <label>Tipo: <input type="text" id="tipoStock" required></label>
      <label>Produto: <input type="text" id="produto" required></label>
      <label>Quantidade: <input type="number" id="quantidade" required></label>
      <button type="submit">Guardar</button>
      <button type="button" onclick="resetForm('formStock')">Cancelar</button>
    </form>
    <table id="tabelaStock"><thead><tr><th>Data</th><th>Tipo</th><th>Produto</th><th>Qtd</th></tr></thead><tbody></tbody></table>
    <div id="totalStock" class="total"></div>
  </div>

  <!-- Filtros -->
  <div class="content" id="filtros">
    <h2>Filtros</h2>
    <form id="formFiltro">
      <input type="hidden" id="indiceEditarFiltro">
      <label>Empresa: <input type="text" id="empresaFiltro" required></label>
      <label>Edifício: <input type="text" id="edificioFiltro" required></label>
      <label>Data: <input type="date" id="dataFiltro" required></label>
      <button type="submit">Guardar</button>
      <button type="button" onclick="resetForm('formFiltro')">Cancelar</button>
    </form>
    <table id="tabelaFiltro"><thead><tr><th>Empresa</th><th>Edifício</th><th>Data</th></tr></thead><tbody></tbody></table>
    <div id="totalFiltro" class="total"></div>
  </div>

  <!-- Notas -->
  <div class="content" id="notas">
    <h2>Notas</h2>
    <input type="hidden" id="indiceEditarNota">
    <textarea id="textoNota" rows="4" cols="247"></textarea><br>
    <button onclick="guardarNota()">Guardar Nota</button>
    <button onclick="resetFormNota()">Cancelar</button>
    <table id="tabelaNotas"><thead><tr><th>Nota</th></tr></thead><tbody></tbody></table>
    <div id="totalNotas" class="total"></div>
  </div>

  <!-- Excel -->
  <div class="content" id="excel">
    <h2>Importar / Exportar Excel</h2>
    <input type="file" id="inputExcel" accept=".xlsx,.xls" />
    <button onclick="importarExcel()">Importar do Excel</button>
    <button onclick="exportarExcel()">Exportar para Excel</button>
  </div>

  <script>
    // --------- DADOS ---------
    let manutencoes = [], stock = [], filtros = [], notas = [];

    // --------- TABS ---------
    document.querySelectorAll(".tab").forEach(tab => {
      tab.addEventListener("click", () => {
        document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
        document.querySelectorAll(".content").forEach(c => c.classList.remove("active"));
        tab.classList.add("active");
        document.getElementById(tab.dataset.tab).classList.add("active");
      });
    });

    // --------- GUARDAR ---------
    document.getElementById("formNovo").addEventListener("submit", e => {
      e.preventDefault();
      const idx = indiceEditarNovo.value;
      const reg = { empresa: empresa.value, edificio: edificio.value, tipo: tipo.value, data: dataNovo.value, obs: obs.value };
      if (idx) manutencoes[idx] = reg; else manutencoes.push(reg);
      renderNovo(); resetForm("formNovo");
    });

    document.getElementById("formStock").addEventListener("submit", e => {
      e.preventDefault();
      const idx = indiceEditarStock.value;
      const reg = { data: dataStock.value, tipo: tipoStock.value, produto: produto.value, quantidade: quantidade.value };
      if (idx) stock[idx] = reg; else stock.push(reg);
      renderStock(); resetForm("formStock");
    });

    document.getElementById("formFiltro").addEventListener("submit", e => {
      e.preventDefault();
      const idx = indiceEditarFiltro.value;
      const reg = { empresa: empresaFiltro.value, edificio: edificioFiltro.value, data: dataFiltro.value };
      if (idx) filtros[idx] = reg; else filtros.push(reg);
      renderFiltro(); resetForm("formFiltro");
    });

    function guardarNota() {
      const idx = indiceEditarNota.value;
      if (idx) notas[idx] = textoNota.value; else notas.push(textoNota.value);
      renderNota(); resetFormNota();
    }

    // --------- RENDER ---------
    function renderNovo() {
      renderTabela("tabelaNovo", manutencoes, ["empresa","edificio","tipo","data","obs"], "totalNovo", "manutencoes", "formNovo");
    }
    function renderStock() {
      renderTabela("tabelaStock", stock, ["data","tipo","produto","quantidade"], "totalStock", "stock", "formStock");
    }
    function renderFiltro() {
      renderTabela("tabelaFiltro", filtros, ["empresa","edificio","data"], "totalFiltro", "filtros", "formFiltro");
    }
    function renderNota() {
      const dados = notas.map(n => ({Nota: n}));
      renderTabela("tabelaNotas", dados, ["Nota"], "totalNotas", "notas", "formNota");
    }

    function renderTabela(id, dados, campos, totalId, key, formId) {
      const tbody = document.querySelector(`#${id} tbody`);
      tbody.innerHTML = "";
      dados.forEach((item, i) => {
        const tr = document.createElement("tr");
        campos.forEach(c => {
          const td = document.createElement("td");
          td.textContent = item[c] ?? "";
          tr.appendChild(td);
        });
        tr.onclick = () => selecionarLinha(tr, key, i, document.getElementById(formId));
        tbody.appendChild(tr);
      });
      document.getElementById(totalId).textContent = "Total: " + dados.length;
    }

    // --------- SELEÇÃO ---------
    function selecionarLinha(tr, key, index, form) {
      document.querySelectorAll("tr.selected").forEach(r => r.classList.remove("selected"));
      tr.classList.add("selected");

      let dados;
      if (key === "manutencoes") dados = manutencoes[index];
      if (key === "stock") dados = stock[index];
      if (key === "filtros") dados = filtros[index];
      if (key === "notas") dados = { Nota: notas[index] };

      if (!dados) return;

      if (key === "manutencoes") {
        empresa.value = dados.empresa; edificio.value = dados.edificio; tipo.value = dados.tipo;
        dataNovo.value = dados.data; obs.value = dados.obs; indiceEditarNovo.value = index;
      } else if (key === "stock") {
        dataStock.value = dados.data; tipoStock.value = dados.tipo; produto.value = dados.produto;
        quantidade.value = dados.quantidade; indiceEditarStock.value = index;
      } else if (key === "filtros") {
        empresaFiltro.value = dados.empresa; edificioFiltro.value = dados.edificio;
        dataFiltro.value = dados.data; indiceEditarFiltro.value = index;
      } else if (key === "notas") {
        textoNota.value = dados.Nota; indiceEditarNota.value = index;
      }

      tr.ondblclick = () => {
        if (confirm("Apagar este registo?")) {
          if (key === "manutencoes") { manutencoes.splice(index,1); renderNovo(); }
          if (key === "stock") { stock.splice(index,1); renderStock(); }
          if (key === "filtros") { filtros.splice(index,1); renderFiltro(); }
          if (key === "notas") { notas.splice(index,1); renderNota(); }
          resetForm(form.id);
        }
      };
    }

    // --------- RESET ---------
    function resetForm(id) { document.getElementById(id).reset(); document.querySelector(`#${id} input[type=hidden]`).value = ""; }
    function resetFormNota() { textoNota.value = ""; indiceEditarNota.value = ""; }

    // --------- EXPORTAR ---------
    function exportarExcel() {
      const wb = XLSX.utils.book_new();
      if (manutencoes.length) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(manutencoes), "Manutencoes");
      if (stock.length) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(stock), "Stock");
      if (filtros.length) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(filtros), "Filtros");
      if (notas.length) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(notas.map(n => ({Nota: n}))), "Notas");
      XLSX.writeFile(wb, "dados.xlsx");
    }

    // --------- IMPORTAR ---------
    function importarExcel() {
      const file = document.getElementById("inputExcel").files[0];
      if (!file) { alert("Escolha um ficheiro Excel."); return; }
      const reader = new FileReader();
      reader.onload = e => {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: "array" });
        if (workbook.Sheets["Manutencoes"]) { manutencoes = XLSX.utils.sheet_to_json(workbook.Sheets["Manutencoes"]); renderNovo(); }
        if (workbook.Sheets["Stock"]) { stock = XLSX.utils.sheet_to_json(workbook.Sheets["Stock"]); renderStock(); }
        if (workbook.Sheets["Filtros"]) { filtros = XLSX.utils.sheet_to_json(workbook.Sheets["Filtros"]); renderFiltro(); }
        if (workbook.Sheets["Notas"]) { const rows = XLSX.utils.sheet_to_json(workbook.Sheets["Notas"]); notas = rows.map(r => r.Nota); renderNota(); }
        alert("Dados importados!");
      };
      reader.readAsArrayBuffer(file);
    }
  </script>
</body>
</html>
